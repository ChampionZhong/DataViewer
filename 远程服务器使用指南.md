# 远程服务器使用指南（Slurm 管理节点）

本指南介绍如何在 Linux slurm 管理节点上运行 DataViewer 项目，并通过 SSH 端口转发在本地浏览器中访问。

## 📋 前置要求

- 可以 SSH 访问 slurm 管理节点
- 管理节点上已安装 Node.js（建议版本 >= 16）
- 本地电脑可以通过 SSH 连接到管理节点

## 🚀 步骤一：在管理节点上部署项目

### 1. 上传项目到管理节点

你可以使用以下任一方式将项目上传到管理节点：

**方式 A：使用 scp 命令**

```bash
# 在本地电脑执行
scp -r /path/to/DataViewer username@slurm-host:/path/to/destination/
```

**方式 B：使用 rsync 命令（推荐，支持增量同步）**

```bash
# 在本地电脑执行
rsync -avz --exclude 'node_modules' \
  /path/to/DataViewer/ \
  username@slurm-host:/path/to/destination/DataViewer/
```

**方式 C：使用 git clone**

```bash
# 在管理节点上执行
git clone <your-repo-url> DataViewer
cd DataViewer
```

### 2. SSH 登录到管理节点

```bash
ssh username@slurm-host
```

### 3. 进入项目目录并安装依赖

```bash
cd /path/to/DataViewer
npm install
```

如果管理节点上没有 Node.js，可以使用以下方式安装：

```bash
# 使用 conda 安装（推荐）
conda install -c conda-forge nodejs

# 或使用 nvm 安装
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
```

## 🔌 步骤二：配置端口转发

### 方法 1：启动服务器后配置端口转发（推荐）

**在管理节点上启动开发服务器：**

```bash
cd /path/to/DataViewer
npm run dev
```

你会看到类似的输出：
```
  VITE v5.0.8  ready in 500 ms

  ➜  Local:   http://localhost:3000/
  ➜  Network: use --host to expose
  ➜  press h to show help
```

**在本地电脑新开一个终端，建立 SSH 隧道：**

```bash
ssh -L 3000:localhost:3000 username@slurm-host
```

参数说明：
- `-L 3000:localhost:3000`：将本地的 3000 端口转发到远程的 3000 端口
- 格式：`-L [本地端口]:[远程主机]:[远程端口]`

**在本地浏览器访问：**

打开浏览器访问 `http://localhost:3000`

### 方法 2：一条命令启动并转发（适合临时使用）

```bash
ssh -L 3000:localhost:3000 username@slurm-host "cd /path/to/DataViewer && npm run dev"
```

### 方法 3：使用不同的本地端口（避免端口冲突）

如果本地 3000 端口已被占用，可以使用其他端口：

```bash
# 将远程 3000 端口转发到本地 8080 端口
ssh -L 8080:localhost:3000 username@slurm-host
```

然后在本地浏览器访问 `http://localhost:8080`

## 🔧 步骤三：配置更灵活的访问方式

### 修改 Vite 配置以绑定所有网络接口

如果你需要从其他节点访问，可以修改 `vite.config.ts`：

```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    port: 3000,
    host: '0.0.0.0',  // 添加这行，允许外部访问
    strictPort: true,  // 可选：如果端口被占用则失败
  },
})
```

然后可以通过以下方式访问：

```bash
# 方式 1：转发到管理节点的特定网络接口
ssh -L 3000:<管理节点内网IP>:3000 username@slurm-host

# 方式 2：如果管理节点有外网 IP，直接访问（需要防火墙允许）
http://<管理节点IP>:3000
```

## 🎯 常用场景和技巧

### 1. 后台运行服务器

如果你希望断开 SSH 后服务器继续运行：

```bash
# 使用 screen
screen -S dataviewer
cd /path/to/DataViewer
npm run dev
# 按 Ctrl+A 然后 D 分离会话

# 重新连接
screen -r dataviewer

# 或使用 tmux
tmux new -s dataviewer
cd /path/to/DataViewer
npm run dev
# 按 Ctrl+B 然后 D 分离会话

# 重新连接
tmux attach -t dataviewer

# 或使用 nohup
nohup npm run dev > dataviewer.log 2>&1 &
```

### 2. 配置 SSH 配置文件简化连接

编辑 `~/.ssh/config`（在本地电脑上）：

```
Host slurm
    HostName slurm-host-address
    User your-username
    LocalForward 3000 localhost:3000
```

然后只需执行：
```bash
ssh slurm
```

就会自动建立端口转发。

### 3. 使用生产构建

对于长期使用，建议构建生产版本：

```bash
# 在管理节点上执行
cd /path/to/DataViewer
npm run build

# 使用简单的 HTTP 服务器运行
npx serve -s dist -l 3000

# 或使用 Python 的 HTTP 服务器
cd dist
python3 -m http.server 3000
```

### 4. 自定义端口

如果 3000 端口被占用，可以修改端口：

**修改 `vite.config.ts`：**
```typescript
server: {
  port: 5173,  // 改成其他端口
}
```

**相应地修改 SSH 转发命令：**
```bash
ssh -L 5173:localhost:5173 username@slurm-host
```

### 5. 通过计算节点运行

如果需要在计算节点上运行（通过 slurm 提交任务）：

创建提交脚本 `run_dataviewer.sh`：

```bash
#!/bin/bash
#SBATCH --job-name=dataviewer
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=2
#SBATCH --time=08:00:00
#SBATCH --mem=4G

# 加载 Node.js 环境
module load nodejs  # 如果你的集群使用 module

# 或使用 conda
# source activate base
# conda activate your-env

cd /path/to/DataViewer
npm run dev -- --host 0.0.0.0 --port 3000
```

提交任务：
```bash
sbatch run_dataviewer.sh
```

查看任务运行的节点：
```bash
squeue -u $USER
```

建立到计算节点的转发：
```bash
# 假设任务在 compute-node-01 上运行
ssh -L 3000:compute-node-01:3000 username@slurm-host
```

## ⚠️ 注意事项

1. **安全性**：确保只在受信任的网络环境中使用，不要暴露敏感数据
2. **端口冲突**：如果端口被占用，选择其他端口
3. **防火墙**：如果使用 `host: '0.0.0.0'`，确保防火墙规则正确配置
4. **资源使用**：在管理节点上运行时注意资源使用，避免影响其他用户
5. **会话保持**：使用 screen/tmux 保持服务器会话，避免 SSH 断开后进程结束

## 🐛 故障排查

### 问题 1：端口转发不工作

```bash
# 检查端口是否被监听
netstat -tlnp | grep 3000

# 或使用 ss
ss -tlnp | grep 3000

# 检查进程
ps aux | grep vite
```

### 问题 2：无法访问 localhost:3000

- 确认 SSH 隧道已建立
- 检查本地端口是否被占用：`lsof -i :3000`（macOS/Linux）
- 尝试访问 `http://127.0.0.1:3000`

### 问题 3：权限问题

```bash
# 确保有执行权限
chmod +x install.sh
./install.sh
```

### 问题 4：npm install 失败

```bash
# 清理缓存重试
rm -rf node_modules package-lock.json
npm cache clean --force
npm install
```

## 📚 相关资源

- [SSH 端口转发详解](https://www.ssh.com/academy/ssh/tunneling/example)
- [Vite 服务器配置文档](https://vitejs.dev/config/server-options.html)
- [Screen 使用指南](https://www.gnu.org/software/screen/manual/screen.html)
- [Tmux 使用指南](https://github.com/tmux/tmux/wiki)

---

如有问题，请参考项目主 README.md 或提交 Issue。

